## Mac OS X 背后的故事（十六）向 Intel 迁移！（下）
**Intel意识到了自己的错误，果断终止了Itanium的开发，并重振旗鼓研发出了Pentium芯片和一系列的后继产品。这一举措让苹果看到了与之合作的希望，它们历时三年完成了软件和硬件的底层移植，之后又先后运用了模拟器和通用二进制技术，最终彻底完成了这场“浩荡”的大迁移。**

#### 成大事者，必有远见
由于AMD技术在很多方面远胜Intel，且允许用户选择比Intel高的频率来跑运算，所以受到了很多计算机爱好者的青睐。另外，AMD不断下压其产品价格，一时间门庭若市，消费者络绎不绝。甚至Intel的好朋友微软也前来插上一脚，联合AMD搞出了X86-64架构的Windows XP。昔日风光的Intel顿时成了业界人人欺负、人人嘲笑的对象。
就是在这个节骨眼上，苹果正在计划把整套Mac产品线迁移到x86上。他们自然之道Intel的Itanium必定会失败，也在先前多次嘲笑使用NetBurst框架的Pentium 4的长流水技术效能是多么的低，他们之道AMD会给出更低的价格，也知道AMD的64位技术，连x86平台都不用迁移了，可以直接迁到x86-64上。
但在这里我不得不佩服苹果在这个决策上的远见。他们没有选择AMD，而是选择了但是不被看好的Intel，哪怕在前一年他们还在开发者大会上嘲笑Wintel联盟。他们做出这个明智的选择，是因为Intel在这时，已经充分意识到自己的错误，正在迎头赶上。Intel基本砍掉了Itanium的开发工作，工作重心重新回到了x86，而之前的x86，Intel倾向于使用NetBurst。在长流水的NetBurst框架中，整条流水长为20步。的确，把长流水加长，可以简化每一步操作，从而增加时钟频率，使程序高速地执行。但这时遇到两个问题。如果分支预测做出了错误的猜测，那进入整条流水的指令都得扔掉换取新的指令重算。因此，误判一次，长流水将付出大得多的误判代价。另一方面，时钟频率不可能无限制的加快，把时钟频率加快一倍，能耗会成为原来的四倍多，散热、待机时间都会成问题。
Intel向苹果展示出他们的蓝图--他们早早地意识到移动计算领域的重要性，所以NetBurst必定走不通。于是他们立即回头，弃掉整个方案，使用之前废弃的P6技术，重振旗鼓，研发出Pentium M移动芯片，并打算在此基础上发展出一系列后继产品（Core、Nehalem系列技术，其中包括了和AMD类似的64位技术）。他们向苹果承诺自己即将推出的产品不但可以在性能上干翻别的处理器，更会在能耗上取胜。
苹果在Intel展示的蓝图中，看到了自己的未来--他们之前是多么希望PowerPC研发出3GHz的芯片，但几年过去了却丝毫不见影子；他们是多么想把PowerOC G5放到笔记本电脑或iMac上，但为了冷却它，苹果得安装巨大的风扇，且电池撑不了多久。如果全套使用Intel的方案，他们就可以马上把高性能低功耗的产品推向市场。因此，虽然AMD当时占领了越来越多的桌面份额，但由于功耗问题，它依然不是苹果的菜。Intel和苹果两大公司一拍即合，开始合作。所以2005年6月6日WWDC上，Steve Jobs胸有成竹地走上台，发布往Intel平台迁移的消息。他特别指出，如果以消耗的能源作对比基准，以瓦特作单位。Intel处理器的表现要远远好于PowerPC处理器。而在手提电脑的设计里，这是一个非常重要的考虑因素，这一性能指标将严重影响电脑的寿命与使用时间。
这个迁移计划包括硬件和软件两个部分。硬件部分的整个迁移计划准备在2006年6月开始行动，在2007年末结束，但实际上苹果的平台迁移进行得比料想中快得多。首代配备了Intel处理器的Mac电脑于2006年1月推出，并在2006年10月推出最后一款需要迁移至Intel平台的产品--Xserver。最终Xserver服务器于2006年12月推出，硬件层面的Intel平台迁移此时宣告完结。Intel实现了其原先在性能和功耗上的承诺。从速度上，Intel的Core Due处理器的实际性能表现基础可以与原先的Power Mac G5台式机媲美；能耗上，苹果的iBook、PowerBook被以MacBook、MacBook Pro重命名，且基本都使用了当时较新的芯片类型。更夸张的是，2006年年中推出的Mac Pro替换掉了原先的Power Mac，因为根本不需要先前提到的高级散热系统，所以巨型的风扇被移走，腾出的空间足够让用户装更多的硬盘。
软件部分则完全依赖于Marklar计划所打下的底子。那天在WWDC现场，Steve Jobs突然告诉观众，舞台上那台用了一上午的演示电脑，其实是Intel核心的，他特地点开了系统配置窗口让观众确认，引来了观众的惊异声。他展示了多个Mac OS X的自带软件，可以看到，虽然还是测试版。在一年后的MacWorld上，Jobs自豪地声称，Mac OS X的8600行代码，已经完全从PowerPC迁至Intel。2009年8月28日发布的Mac OS X 10.6 Snow leopard仅支持Intel处理器，标志着对PowerPC支持的结束。

#### 多管齐下，为应用移植扫清障碍
操作系统只是底层，用户更关心的是整个应用程序生态圈。Java程序和Dashboard Widget程序本身都是和平台无关的，所以用户不用担心迁移问题。那对于之前用户所用的PowerPC程序怎么办呢？苹果使用了当初解决迁移68k到PowerOC上的老办法----模拟器。这款名为Rosetta的模拟器会把用户程序翻译成Intel x86的指令。在演讲当天，Steve Jobs演示了PhotoShop、Microsoft World等用户喜闻乐见的程序，运行都很流畅。苹果系统中的所有系统库，也提供了PowerPC程序调用。所以Rosetta最终的指令都会转成Intel计算指令和向XNU核心的系统调用。对于用户使用的大多数图形界面程序而言，系统调用居多，且大多时间是计算器闲置等待用户输入，因此，使用Rosetta虚拟的程序，其性能问题并不明显，用户普遍表示压力不大。
Rosetta毕竟只是无奈之举，对于应用软件开发者，苹果则呼吁他们赶紧把程序在x86平台重新编译。为了减轻开发人员移植平台时的负担，苹果推出了一项新技术----通用二进制程序（Universal Binary）。其实这和之前介绍的胖二进制没有任何区别，只是为了这次迁移的商业宣传的需要改了个新名字而已。在用一个程序包中同时为两种架构提供二进制码，使应用程序能以原生形式运行在使用PowerPC或Intel x86的Mac电脑上。当程序在Mac OS X中执行后，操作系统将自动检测通用二进制码，然后根据使用的硬件架构自动选择合适的程序代码来执行。后来，苹果在Mac OS X 10.5中正式支持64位的Cocoa框架（详见《Mac OS X背后的故事----半导体的丰收》），苹果进一步扩充了通用二进制码的功能，引入“四架构二进制”的概念（对应Intel及PowerOC平台的32位及64位版本）。
我认为，这个技术并不花哨，但体现了苹果对用户的体贴。用户购买Mac OS X软件或别的Mac软件时，无需按照该架构购买相应的软件，这种设计减少了软件发布商和用户诸多不必要的麻烦。
那么，要编译一个通用二进制的程序会有多麻烦呢？Steve Jobs在会上告诉大家，这和当年大家花三个月把程序用Carbon重写以从Mac OS迁移到Mac OS X不同，我们今天要发布Xcode 2.1版本的Xcode在编译选项中会弹出一个菜单让你勾选想要生成Intel或是PowerPC代码。而开发者所需要做的事就是把两个勾全勾上，然后呢？然后就没有然后了